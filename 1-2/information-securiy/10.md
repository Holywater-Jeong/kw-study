# 10주차. 네트워크 보안

# 스니핑

- 냄새를 맡다, 코를 킁킁 거리다
- 데이터를 중간 도청하는 것

## 스니핑 기법1: 허브

- 허브: 더미 허브 또는 수동 허브
  - 일종의 리피터: 입력 받은 패킷을 나머지 모든 포트로 단순히 전달
  - 운영체제 상 다른 PC로 전달되는 패킷을 무시
    - 네트워크카드의 셋팅
      - 자신의 MAC주소 아닌 패킷들은 필터링
- 네트워크 카드: 무차별 모드로 설정
  - 나의 MAC 주소가 아닌 패킷도 전달받는 모드 -> 허브환경에서 스니핑 가능

## 스니핑 기법2: 스위치

- 스위치: MAC 주소 정보를 이용하여 패킷을 해당 목적지로만 전달 -> 무차별 모드로 셋팅해도 스니핑 불가능
- 스니핑 가능한 케이스
  - 모니터링 포트를 이용
    - 모니터링 포트: 스위치를 통과하는 모든 패킷 내용을 전달하는 포트
    - 물리적으로 스위치에 접근 가능하다면 모니터링 포트 통해 스니핑 가능
  - 스위치 재밍을 이용
    - 공격을 받아 더미 허브와 같은 동작을 하게 되는 것
    - 재밍: 전파 방해
    - 매핑 테이블의 최대 저장 개수보다 더 많은 정보가 추가 -> 브로드캐스팅 모드로 동작
      - 매핑 테이블: IP주소를 MAC 주소로 변환하기 위해 내부적으로 관리하는 테이블
      - 브로드캐스팅 모드: 전달받은 모든 패킷을 연결된 모든 단말기에 전달
    - 스위치 재밍 공격 통해 스위치가 마치 더미 허브처럼 동작하게 되기 때문에 통신 속도가 느려짐
  - 스푸핑 공격 기법 이용
    - 공격자가 자신이 수신자인 것 처럼 위장하는 기법
    - ARP 스푸핑 등

## 스니핑 방지 대책: 암호화

- 가장 효과적인 것은 암호화
- 웹 환경의 HTTPS
  - 암호화된 통신 프로토콜
  - HTTP + SSL/TLS
- 이메일 환경의 PGP와 S/MIME
  - PGP(Pretty Good Privacy): 사용하기 편하고 사용된 알고리즘의 안정성이 높기 때문에 대중적으로 사용
    - 필립 짐머만에 의해 개발
  - S/MIME: 이메일의 내용을 저장하는 방식인 MIME에 암호화 기법 추가
- 원격 접속을 위한 SSH
  - SSH(Secure Shell): 암호화된 원격 접근 방식의 대표적인 예
  - 원격이나 텔넷이나 FTP 등을 이용 -> 스니핑을 통해 사용자 ID와 암호가 유출될 수 있음
- VPN
  - 사설망 혹은 사설 가상망
  - 일종의 네트워크 시스템 자체를 의미
    - 전용망과 VPN으로 회사 네트워크를 이용 가능
  - VPN 이용: 공개망을 사용하면서도 전용망을 사용하는 효과 유지
    - 논리적으로는 전용선을 이용하는 것이나 물리적으로는 인터넷 이용
    - 터널링 기술: 두 종단 사이 가상적인 터널 만드는 것
    - 예
      - Remote Access VPN: 두 종단 각각에서 VPN 장비로 접속
      - Dial-Up VPN: 인터넷에서 직접 VPN 장비로 접속
    - 프로토콜: PPTP/L2F/L2TP, IPSec, SOCKS V5 등
- 그 외 스니핑 방지 대책
  - 스위칭 정적 매핑 테이블 사용
  - 연결된 PC의 MAC주소를 미리 조사하여 IP 주소 값 등을 고정시키는 것

## 스니핑 탐지 방법

- 명령어 ping 사용
  - 존재하지 않는 IP주소에 대한 요청에도 응답이 오는지?
- ARP를 이용하는 방법
  - 존재하지 않는 IP주소를 이용하여 ARP 요청을 보냄 -> 응답 여부 통해 스니핑 중인지를 판단
- DNS 방법
  - 존재하지 않는 IP 대상 ping 먼저 보내고 IP에 대한 도메인 이름을 물어보는 요청 (Inverse DNS Lookup)이 오는지 확인
  - 원격 네트워크에서도 사용 가능
- 유인 방법
  - 일부러 가짜 사용자 ID, PW 유출
  - 이후 네트워크 감시 프로그램 통해 유출된 ID가 사용되는지 분석
- 호스트 기반 탐지 도구: ifconfig, promiscdetect
- 네트워크 기반 탐지 도구: ARP watch

# 스푸핑

- 공격자가 마치 공격 대상자인 것 처럼 행세하는 것
- 원래 의미: 다른 사람을 흉내내는 것 혹은 따라하는 장난
- 공격자는 마치 자신이 수신자인 것 처럼 행세하여 송신자가 보낸 메시지를 강탈
- 다양한 스푸핑 기법의 종류들
  - 2계층: 공격자가 같은 스위치 내 존재 - ARP 스푸핑
  - 3계층(IP, ICMP 리다이렉트) or 7계층(DNS): 공격자가 내부 네트워크 및 외부 네트워크에서도 공격 가능

## ARP 스푸핑

- 공격자가 공격 대상자의 MAC주소를 가로채는 공격
  - IP주소로 보내더라도 내부적으로는 MAC 주소로 변환되어 전송됨
  -

#### ARP의 동작 원리

- ARP
  - MAC주소를 결정하기 위한 통신 프로토콜
  - IP주소를 MAC 주소로 변환하는 역할
    - 하드웨어 주소: 네트워크 카드별로 부여되는 고유한 번호
- 같은 로컬네트워크에 단말이 있는 경우
  - ARP 요청 예: IP주소 IP B에 대한 MAC 주소가 없다면
  - 1. 단말 A: 단말 B의 MAC주소를 모르기 때문에 스위치로 ARP 요청을 보냄
  - 2. 스위치: ARP 요청을 받으면 자신에게 접속된 모든 단말에게 ARP 요청을 브로드캐스트 방식으로 전송
  - 3. 단말 B: ARP 요청을 전달받은 단말 중에서 실제 요청한 IP주소를 가진 단말이 있다면 이 단말은 ARP 응답을 보냄
  - 4. 단말 A: ARP 응답을 전달 받아 자신의 ARP 테이블에 B의 MAC 주소를 추가
- 외부 네트워크에 단말이 있는 경우
  - 외부 네트워크의 통로가 되는 게이트웨이의 MAC주소가 해당 IP의 MAC주소로 설정
  - ARP 응답의 예: 외부에 있는 단말 C에 대한 MAC 주소 추가

#### ARP 스푸핑 과정

- 핵심
  - 공격자가 스위치 내 다른 단말에 가짜 ARP 응답을 보내는 것이 핵심
  - ARP 응답을 스위치 내 다른 단말에 지속적으로 보내서 가짜 MAC주소를 자신의 ARP 테이블에 반영
- Step 1: MAC주소를 가짜 MAC 주소로 변경
  - 공격자 I: 스위치에 연결된 다른 단말 A에 ARP 응답을 보냄
    - 가짜 ARP 응답에 의해 A의 ARP 테이블 B의 MAC 주소가 MAC I 로 변경
- Step 2: B로 가야 하는 메시지가 공격자 I에게 전송됨
  - A가 B에게 네트워크로 메시지 전송
    - A는 B의 IP 주소인 IP B로 메시지 전송
      - IP B에 해당하는 MAC 주소는 MAC I로 변경
    - 실제로는 공격자 I에게 메시지가 전달됨

#### ARP 스푸핑을 이용한 스니핑 공격

- Step-1: 스위치 내의 모든 단말의 MAC 주소를 공격자의 MAC주소로 변경
- Step-2: 공격자에게로 전달된 메시지를 원래의 수신자에게 재전송

## ARP 스푸핑의 현상과 탐지 방법

- 지속적인 ARP응답 발생
  - 와이어샤크 같은 패킷 분석 프로그램 이용하여 확인
- ARP 테이블에서 중복된 MAC 주소 확인
  - 명령어: arp -a
- ARP 테이블 감시 프로그램 활용
  - xarp 실행
- 네트워크 속도 저하

## ARP 스푸핑 방지 대책

- 정적 ARP 테이블 관리
  - 관리 비용이 증가해서 어렵다
- PC와 서버의 보안 수준 강화

## IP 스푸핑

- 공격자의 IP 주소를 다른 IP 주소로 속이는 공격 방법
- 자신이 보내는 메시지 안의 IP 주소를 변조하는 것이 핵심
  - IP 헤더 정보에 저장된 출발 IP주소 변조

#### IP 스푸핑을 이용한 보안 공격

- IP 스푸핑 자체가 위협적일 때
  - IP 주소가 인증의 수단이 될 때 - 트러스트 관계

#### IP 스푸핑의 합법적 사용: 웹 성능 테스트

- 내부적으로 IP 변조 기능 사용
  - 대량의 가상 사용자 생성하고 접속하여 진행하는 시뮬레이션
- HP사의 loadRunner

#### IP 스푸핑 방지 방법

- 트러스트 관계를 IP 기반으로 맺지 않고 서버 클러스터링 필요한 경우 트러스트 관계에 있는 서버들의 보안 수준 강화
- 패킷 필터링
  - 게이트웨이 밖에서 시도되는 IP 스푸핑 공격에 대한 방지 수단
    - 게이트웨이: 외부에서 내부 네트워크로 전달되는 메시지가 거쳐 가는 중간 관문
  - 외부에서 내부로 전달되는 메시지 중에서 출발 IP가 내부 IP로 설정된 메시지를 필터링(차단)

## ICMP 스푸핑

- ICMP: 네트워크 상 현재 오류 진단, 제어 목적 프로토콜
- ICMP 사용 목적
  - 네트워크 진단: 네트워크 연결 여부 확인 ping 또는 traceroute
  - 네트워크 흐름 통제: 게이트웨이가 2개인 네트워크 환경에서 게이트웨이 IP메시지 재전송
- ICMP 스푸핑 개념
  - Step-1: ICMP 리다이렉트 보내기
  - Step-2: 단말 A에서 보낸 메시지는 먼저 공격자 I에게로 전성됨
  - Step-3: 스니핑 성공을 위해 기존 게이트웨이로 재전송

## DNS

- 접속하려는 URL 주소로 IP 주소를 구하는 서비스
- UDP로 통신

## DNS 스푸핑

공격 대상에게 전달되는 IP주소를 변조하거나 DNS 서버에 변조된 IP 주소가 저장 공격 대상이 의도하지 않은 주소로 접속하게 하는 공격 방법

#### 공격 방법1: 스니핑 이용

- Step-1: DNS 질의를 스니핑
- Step-2: 변조된 DNS 응답의 선택
  - UDP 방식이기에 DNS 응답이 전달되기 때문에 DNS 응답 중 먼저 도착한 메시지만 선택되고 이후 도착 메시지 무시

#### 공격 방법2: DNS 캐시 포이즈닝 - DNS 서버의 IP 주소 변조

- 먼저 DNS 서버의 동작 방식
  - 순환질의 (계층적으로 도메인 주소를 질의)
  - 구해진 IP 주소는 DNS 서버에 캐시로 저장
- DNS 서버에 대한 스푸핑 공격
- 랜덤 ID 생성 기반의 DNS 캐시 포이즈닝
  - Step-1: 대규모 DNS 질의 보냄
  - Step-2: 대규모 DNS 응답을 보냄
    - 여러 개 서로 다른 ID 값을 랜덤하게 생성하여 DNS 응답을 동시에 보냄
    - DNS 서버와 공인 네임 서버가 공유하는 ID 값을 알아맞히기 위해
- 생일공격 기법
  - 생일역설: 한 반에 동시에 23명의 사람이 모여있을 때 그 중 생일 같은 사람 있을 확률 50% 이상
    - 우리가 예상하는 확률보다 실제 확률이 높다
  - DNS 질의 사용되는 ID 크기: 2바이트
    - 65536개 값
    - 750번 랜덤 값 생성시키면 728이라는 값 얻을 수 있다
      - 공격자가 랜덤하게 750개 이상 DNS 응답 생성 -> 그 중 1개는 성공
- 대비책
  - DNS 서버 소프트웨어 업데이트
  - 외부 요청 DNS 질의에 대해서 DNS 서버가 순환 질의 하지 않도록
  - DNSSEC 사용
    - 암호화 하여 DNS 질의 및 응답 전달

# 서비스 거부 공격

- 서비스가 정상적으로 제공되지 못하도록 방해하는 공격
- 공격 목적: 가용성 떨어트리는 것
- 분산 서비스 거부 공격: 공격자가 여러 곳에서 동시에 서비스 거부 공격을 하는 방법

## 공격 유형

- 대역폭 소진 공격
  - 형태
    - TCP SYN Flooding
    - ICMP/UDP Flooding
    - IP Flooding
  - 대상: 네트워크 인프라
  - 증상: 네트워크 대역폭 고갈
- 서버 마비 공격
  - 형태: HTTP Get Flooding
  - 대상: 웹서버, 정보보호 장비
  - 증상: 공격 대상 시스템만 피해

> 명백한 범법 행위: 자랑, 반사이익, 협박

## TCP SYN Flooding

- SYN 패킷을 대량으로 보내 웹 서버 네트워크 대역폭 낭비하여 일반사용자 아예 웹 서버로 접속 못하게 하는 방법
- TCP 3웨이 핸드셰이킹 특징 악용
  - 처음 두 단계가 이루어진 다음에 송신자가 세 번 째 단계 ACK 패킷 안 보내면 계속 수신자는 기다린다. 10초 ~ 1분
- 대기 큐에서 지워지는 속도보다 채워지는 속도가 더 빠르게 만든다
- 대응 방안
  - 대기 큐 크기 증가: 자원 한계
  - 최대 접속 대기시간 감소: ACK 패킷 2초 내 안 오면 강제 접속 종료
  - 보안 솔루션: 침입 방지 시스템(IPS)

## ICMP 플러딩: 스머프 공격

- 대량의 ICMP echo 응답 만들어 공격
- 브로드 캐스팅 방식으로 동작하는 ICMP 프로토콜 특성 악용
- ICMP echo 출발 IP 변조
- 에이전트, 슬레이브, 봇, 좀비 등의 용어가 있다

#### 공격 단계

- Step-1: 공격자에 의한 브로드캐스트
- Step-2: 에이전트에 의한 공격 실행
  - 변조된 ICMP echo 요청을 받은 에이전트들이 동시 ICMP echo 응답을 공격 대상자에게 보냄

#### 분산서비스거부공격의 구조

- 구성요소: 공격자, 공격대상자, 에이전트, 마스터
- 에이전트: 공격 대상자에게 실제 공격하는 주체 (슬레이브, 봇, 좀비)
- 마스터: 중간 증폭기 역할 (전달 공격자로부터 공격 명령 받아 에이전트로 전달)

## IP 플러딩

- 서비스 거부 공격 위해 공격자가 IP 관련 내용 변조하는 공격 방식
- 종류
  - 랜드
    - 출발지 IP 주소를 변조 (출발지 IP주소와 도착지 IP주소를 같게 하여 보냄)
    - 대처방안
      - 패치
      - 방화벽, 보안 솔루션 (예외 처리)
  - 티어드랍
    - IP 패킷 순서 변조 - 헤더를 서로 중첩되도록 조작, IP 패킷을 재조합 과정에서 오류 발생
    - 대처방안
      - 시퀀스 번호에 오류가 있는 IP 패킷 무시

## HTTP Get Flooding

- 특정 웹 페이지를 동시에 여러 에이전트가 공격하여 웹 서버가 이를 감당하지 못하게 만들어 서비스 거부 일으키는 방법
- 대처 어렵다: 정상적 HTTP 요청을 단순히 거부할 수는 없기 때문
- 대응 방안
  - 임계치 기반 방어 기법
  - 특정 IP에서 임계치 넘어서는 요청 지속된다면 무시하도록

#### HTTP CC공격, 동적 HTTP 요청 공격

- CC
  - HTTP 헤더 CC옵션 변경하여 더 많은 부하 유발 - 캐시 기능 사용하지 못함
  - 방어: 임계치 기반 방어
- 동적 HTTP
  - 지속적 요청하는 웹 페이지 주소 변경하여 차단 우회 시도
  - 임계치 적용 어렵다
    - 출발지 IP 주소 기반의 임게치 기반의 차단 정책
