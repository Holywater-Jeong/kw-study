# 6주차. 블록 암호 모드

# 블록 암호 모드

## 블록 암호와 스트림 암호

- 블록 암호
  - 어느 특정 비트 수의 집합을 한 번에 처리하는 암호 알고리즘
  - 이 집합을 블록이라 한다
  - 블록의 비트 수를 블록 길이라고 한다
    - DES나 트리플 DES의 블록 길이는 64비트
    - DES: 64비트 평문, 64비트 암호문
    - AES: 블록 길이는 128비트, 192비트, 256비트
- 스트림 암호
  - 데이터의 흐름을 순차적으로 처리해 가는 암호 알고리즘
  - 1비트, 8비트, 혹은 32비트 등의 단위로 암호화와 복호화

## 모드란

- 모드
  - 긴 평문을 블록으로 나누어 암호화
  - 각 블록에 암호 알고리즘을 반복 사용하여 긴 평문 전체를 암호화

#### 블록 암호 주요 모드

- ECB: 전자 부호표 모드
- CBC: 암호 블록 연쇄 모드
- CFB: 암호 피드백 모드
- OFB: 출력 피드백 모드
- CTR: 카운터 모드

## 평문 블록과 암호문 블록

- 평문 블록: 블록 암호 알고리즘의 암호화 대상
- 암호문 블록: 블록 암호 알고리즘의 복호화 대상

## 적극적 공격자 맬로리

- 도청
- 위장
- 변조
- 공격자: 맬로리

# ECB 모드

## ECB 모드

- 평문 블록을 암호화한 것이 그대로 암호문 블록
- 패딩
  - 마지막 평문 블록이 블록 길이에 미치지 못할 경우 추가하여 블록 길이가 되도록 맞춘다
- 안전하지 않다

#### ECB 모드에 의한 암복호화

- 평문 블록1, 평문 블록2, 평문 블록n...
- 암호화(복호화)
- 암호문 블록1, 암호문 블록2, 암호문 블록n...

## ECB 모드의 특징

- 가장 기밀성이 낮다
- 암호문을 살펴보는 것만으로도 평문 속 패턴 반복성 감지 가능

## ECB 모드에 대한 공격

- 어느 은행의 송금 의뢰 데이터가 다음 3개의 블록으로 구성
  - 블록1 = 송금자 계좌
  - 블록2 = 송금처 계좌
  - 블록3 = 송금액
- 송금 의뢰 데이터를 받은 은행은 지정된 금액을 송금자로부터 송금처의 계좌 이동

#### 예) A-5374 계좌로부터 B-6671의 계좌로 1억원을 송금하라는 송금 의뢰 데이터 만드는 과정

- ECB 모드로 암호화
- 맬로리가 블록의 1과 2의 내용을 바꾸면 송금자와 송금처가 바뀐다

# CBC 모드

## CBC 모드

- 암흐 블록 연쇄 모드이다
- 암호문 블록을 마치 체인처럼 연결시키기 때문에 붙여짐
- 한 단계 앞에서 수행되어 결과로 출력된 암호문 블록에 평문 블록을 XOR 하고 나서 암호화
- 각각 암호문 블록은 단지 현재 평문 블록 뿐만 아니라 그 이전의 평문 블록들의 영향도 받게 된다

#### CBC 모드에 의한 암호화

- 평문 블록1 XOR IV(초기화 벡터)
- 암호문 블록1 XOR 평문 블록2
- 암호문 블록2 XOR 평문 블록3...

#### CBC 모드에 의한 복호화

- 암호문 블록1 XOR IV
- 평문 블록1 XOR 암호문 블록2...

## 초기화 벡터

최초 평문 블록을 암호화 할 때는 한 단계 앞의 암호문 블록이 존재하지 않으므로 대신할 비트 열인 한 개의 블록을 준비할 필요가 있어서 만들어짐

## CBC 모드의 특징

- 평문 블록은 반드시 한 단계 앞의 암호문 블록과 XOR 취하고 나서 암호화
- 따라서 평문 블록 1과 2의 값이 같아도 암호문 블록 1과 2의 값이 같아진다고 할 수 없어서 ECB 모드가 갖고 있는 결점이 없다
- 암호문 블록3을 만들고 싶다면 적어도 평문 블록의 1, 2, 3 까지가 갖춰져 있어야 한다

#### 깨진 암호문 블록에 의한 영향

- 암호문 블록이 파손되면 2개의 평문 블록에 영향을 미친다

#### 비트 누락

- 암호문 블록에서 비트가 누락되면 그 이후 평문 블록 전체에 영향을 미친다

## CBC 모드에 대한 공격

- 초기화 벡터에 대한 공격
  - 맬로리가 초기화 벡터의 임의의 비트를 반전시킬 수 있다면 암호 블록 1에 대응하는 평문 블록1의 비트를 반전시킬 수 있다

## 패딩 오라클 공격

- 블록 암호의 패딩을 이용한 공격
- 패딩 내용을 조금씩 변화시켜 암호문을 여러 차례 송신
- 수신자가 올바로 복호화 하지 못할 경우 오류를 관찰하여 평문 정보를 취득
- 패딩을 사용하는 모든 모드에 적용

## 초기화 벡터 공격

- 초기화 벡터는 난수로 부여
- SSL/TLS의 TLS 버전 1.0
  - 초기화 벡터를 이전 CBC 모드로 암호화한 마지막 블록을 사용
  - 문제점 발견 후 TLS 버전 1.1 부터는 초기화 벡터를 명시적으로 부여

## CBC 모드 활용 예

- SSL/TLS
  - 통신기밀성 보호 위해 CBC 모드 사용
- 예
  - 3DES-EDL-CBC
    - 트리플 DES를 CBC 모드로 사용
  - AES-256-CBC
    - 키 길이가 256비트인 AES를 CBC 모드로 사용

# 칼럼 (CTS 모드)

- (Cipher Text Stealing) 모드
- 마지막 블록 한 단계 전의 암호화 블록을 패딩으로 대신 이용
- ECB나 CBC 모드와 조합해 사용
- 마지막 블록을 송신하는 순서를 변경하는 변형된 형태로도 운영
- CBC-CS1, CBC-CS2, CBC-CS3

# CFB 모드

- 암호 피드백 모드의 약자
- CFB 모드에서는 한 단계 앞의 암호문 블록을 암호 알고리즘의 입력으로 사용

#### CFB 모드의 암호화

- 초기화 벡터를 암호화하고 평문블록1과 XOR
- 암호문 블록1을 암호화하고 평문블록2와 XOR...

#### CFB 모드의 복호화

- 초기화 벡터를 암호화하고 암호문 블록1과 XOR
- 암호문 블록1을 암호화하고 암호문 블록2와 XOR...

#### CBC와 CFB 비교

- 한 단계 앞의 암호문 블록이 있다는 것은 같다
- CBC는 암호화 전에 평문 블록과 XOR, CFB는 평문 블록을 한 단계 앞의 암호문 블록을 암호화한 키 스트림과 XOR 연산

## 초기화 벡터

- 최초의 암호문 블록을 만들어낼 때는 한 단계 앞의 출력이 존재하지 않으므로 대신에 IV를 사용

## CFB 모드와 스트림 암호

- 키 스트림
  - CFB 모드에서 암호 알고리즘이 생성하는 비트열
  - 키 스트림을 생성하기 위한 의사난수 생성기로서 암호 알고리즘을 이용
  - 초기화 벡터는 의사난수 생성기의 seed에 해당
- CFB 모드는 블록 암호를 써서 생성한 키를 이용하는 스트림 암호

## CFB 모드의 복호화

- CFB 모드에서 복호화를 수행할 경우, 블록 암호 알고리즘 자체는 암호화를 수행하고 있다는 것에 주의
- 키 스트림은 암호화에 의해 생성

## CFB 모드에 대한 공격

#### 재전송 공격

- 암호문 블록 4개 중 3개를 보관하여 다음 날 3개 블록을 교환하여 송신

# OFB 모드

## OFB 모드

- 출력 피드백 모드의 약자
- 암호 알고리즘의 출력을 암호 알고리즘의 입력으로 피드백
- 평문 블록은 암호 알고리즘에 의해 직접 암호화되진 않음
- 평문 블록과 암호 알고리즘의 출력을 XOR해서 암호문 블록을 만든다

#### OFB 모드에 의한 암호화

- IV 암호화 후 평문 블록 XOR해서 암호문 블록1 만들음
- IV 암호화한 값을 암호화해서 평문 블록2와 XOR 후 암호문 블록 2를 만들음...

#### OFB 모드에 의한 복호화

- IV 암호화 후 암호문 블록1과 XOR해서 평문 블록1을 만들음
- IV 암호화한 값을 암호화해서 암호문 블록2와 XOR해서 평문 블록 2를 만들음

## 초기화 벡터

- CBC 모드나 CFB 모드와 마찬가지로 초기화 벡터를 사용
- 초기화 벡터는 암호화 때마다 랜덤 비트열을 이용

## CFB 모드와 OFB 모드의 비교

- 암호 알고리즘으로의 입력만이 다르다

# CTR 모드

- 카운터 모드의 약자
- 카운터 모드는 1씩 증가해 가는 카운터를 암호화해서 키 스트림을 만들어내는 스트림 암호
- 블록을 암호화할 때마다 1씩 증가해 가는 카운터를 암호화해서 키 스트림을 만든다

## 카운터 만드는 법

- 카운터 초기값
  - 암호화 때마다 다른 값을 기초로 해서 작성

#### CTR 모드 암호화

- CTR+(n-1)을 암호화 후 평문 블록 XOR해서 암호문 블록n을 만든다

## OFB 모드와 CTR 모드의 비교

- OFB는 암호화의 출력을 피드백
- 카운터 값이 암호화에 입력된다

## CTR 모드 특징

- CTR 모드의 암호화와 복호화는 완전히 같은 구조
- 프로그램으로 구현하는 것이 매우 간단
- OFB 모드와 같은 스트림 암호의 특징
- CTR 모드에서는 블록을 임의의 순서로 암호화.복호화 가능
- 병렬 처리가 가능한 시스템에서는 CTR 모드를 이용하여 고속으로 처리

## 오류와 기밀성

- CTR 모드의 암호문 블록에서 1비트의 반전 발생 가정
  - 복호화 수행 시 반전된 비트에 대응하는 평문 블록의 1비트만이 반전되고 오류 확대 안됨
- OFB 모드에서는 키 스트림의 1블록의 암호화한 결과가 암호화 전의 결과가 우연히 같아졌다고 하면 그 이후 키 스트림은 완전히 같은 값의 반복됨
  - CTR 모드에서는 그런 걱정 없다

# 칼럼 (GCM 모드)

- Galois/Counter 모드
- CTR 모드에 인증 기능을 추가한 모드
- CTR 모드로 암호문과 인증자를 생성
- 암호문 위조를 탐지할 수 있음

# 모드 비교

## ECB 모드

|          | 이름                                 | 장점                                                                                                                                                                                                                  | 단점                                                                                                                                                                   | 비교                                            |
| -------- | ------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------- |
| ECB      | Electric Code Book, 전자 부호표 모드 | 간단, 고속, 병렬 처리 가능                                                                                                                                                                                            | 평문 속 반복이 암호문에 반영. 암호문 블록의 삭제나 교체에 의한 평문 조작 가능. 비트 단위의 에러가 있는 암호문을 복호화하면 대응하는 블록이 에러가 됨. 재전송 공격 가능 | 사용 X                                          |
| CBC 모드 | Cipher Block Chaining                | 평문의 반복은 암호문에 반영되지 않는다. 병렬 처리 가능(복호화만). 임의의 암호문 블록을 복호화할 수 있다                                                                                                               | 비트 단위 에러가 있는 암호문을 복호화하면 1블록 전체와 다음 블록에 대응하는 비트가 에러가 됨. 암호화에서는 병렬 처리를 할 수 없다                                      | 권장됨                                          |
| CFB 모드 | Cipher FeedBack                      | 패딩이 필요 없다. 병렬 처리 가능(복호화만). 임의의 암호문 블록을 복호화할 수 있다                                                                                                                                     | 암호화에서는 병렬처리를 할 수 없다. 비트 단위의 에러가 있는 암호문을 복호화하면 1블록 전체와 다음 블록의 대응하는 비트가 에러가 된다. 재전송 공격이 가능               | 현재는 사용 안함. CTR 모드를 사용하는 편이 나음 |
| OFB 모드 | Output FeedBack                      | 패딩이 필요없다. 암호화, 복호화의 사전 준비를 할 수 있다. 암호화와 복호화가 같은 구조를 하고 있다. 비트 단위의 에러가 있는 암호문을 복호화하면, 평문의 대응하는 비트만 에러가 된다.                                   | 병렬 처리를 할 수 없다. 적극적 공격자가 암호문 블록을 비트 반전시키면, 대응하는 평문 블록이 비트 반전된다.                                                             | CTR 모드를 사용하는 편이 나음                   |
| CTR 모드 | 카운터                               | 패딩이 필요 없다. 암호화, 복호화의 사전 준비 할 수 있다. 암호화, 복호화가 같은 구조를 하고 있다. 비트 단위의 에러가 있는 암호문을 복호화하면, 평문의 대응하는 비트만 에러가 된다. 병렬 처리 가능(암호화, 복호화 양쪽) | 적극적 공격자가 암호문 블록을 비트 반전 시키면, 대응하는 평문 블록이 비트 반전된다                                                                                     | 권장                                            |

# 정리

- 블록 암호 모드
  - 블록 암호의 선택도 중요하지만 모드의 선택도 중요하다
  - 1개의 블록 암호 알고리즘이라도 용도에 따라 다양한 모드로 응용 가능
  - 각 모드에는 장점과 단점이 있으므로 잘 이해하고 사용해야 한다

# 퀴즈

## 비트와 바이트

8비트를 1바이트라고 한다. 128비트 블록은 몇 바이트인가

> 16 바이트
> 128 비트의 블록 길이를 선택했을 경우 AES는 16바이트의 평문을 암호화해서 16바이트의 암호문을 만든다

## ECB 모드에 대한 공격

적극적 공격자 맬로리가 시스템의 패스워드 파일이 아이디, 패스워드 순으로 반복되어 ECB 모드로 암호화 되어있다고 가정. 이 암호화된 패스워드 파일을 어떻게 바꿔 쓰면 이 컴퓨터 시스템을 공격할 수 있다

> 다양함.
> 암호문 블록 1,3,5를 각각 암호문 블록 2,4,6에 덮어 씌움. 사용자 이름과 패스워드가 같아짐. 사용자 이름만 알아도 로그인 가능

## CBC 모드의 초기화 벡터

CBC 모드에서 항상 같은 값의 초기화 벡터를 사용 시 이 경우 암호 해독자에게 어떤 단서를 주게 되는가

> 어느 평문을 정해진 키로 암호화 했을 때 암호문이 항상 같은 값이 된다. 그러나 암호화 때마다 초기화 벡터를 바꾸면 같은 평문도 다른 암호문이 된다. 가장 좋은 방법은 예측 불가능한 난수를 이용해 매번 초기화 벡터를 만들어야 함

## 모드의 기초 지식

- ECB 모드의 암호화에서는 같은 내용의 평문 블록은 같은 내용의 암호문 블록으로 변한다 -> O
- CBC 모드의 복호화에서는 암호문 블록 3이 파손되어 있으면 암호문 블록 5를 바르게 복호화할 수 없다 -> X
- CFB 모드의 암호화에서는 평문의 도중부터 암호화를 시작할 수 없다 -> O
- OFB 모드로 복호화 수행 시 블록 암호 알고리즘 자체가 실제로 수행하는 처리는 암호화이다 -> O
